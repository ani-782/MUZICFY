// Firebase Auth State Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userIdEl.textContent = User ID: ${currentUserId};
                authReady = true;
                setupFirestoreListeners();
            } else {
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Firebase Auth Error:", error);
                    showMessage("Authentication failed. Please check the console for details.");
                }
            }
        });

    </script>
